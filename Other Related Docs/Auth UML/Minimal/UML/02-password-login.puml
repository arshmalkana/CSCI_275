@startuml Password Login - 2 Step
title Two-Step Password Login Flow

actor User
participant Browser
participant Frontend
participant Backend
participant Database

== Step 1: Username Entry ==
User -> Browser: Enter username "admin"
Browser -> Frontend: Click "Login" button
Frontend -> Backend: POST /v1/auth/webauthn/login/options\n{username: "admin"}
note right: Check if user has passkeys

alt User Has Passkeys
    Backend -> Database: SELECT FROM webauthn_credentials
    Database --> Backend: Found passkeys
    Backend --> Frontend: 200 OK {options}
    Frontend -> Browser: Show Step 2:\n✓ Username display\n✓ "Login with Passkey" button\n✓ "Use password instead" link
else No Passkeys
    Backend --> Frontend: 400 No passkeys
    Frontend -> Browser: Show Step 2:\n✓ Username display\n✓ Password field\n✓ Remember Me toggle\n✓ "Sign In" button
end

== Step 2: Password Authentication ==
User -> Browser: Enter password\nToggle "Remember me" ON
Browser -> Frontend: Click "Sign In"
Frontend -> Backend: POST /v1/auth/login\n{username, password, rememberMe: true}

Backend -> Database: SELECT * FROM staff\nWHERE LOWER(user_id) = LOWER($1)
note right: Case-insensitive lookup

Database --> Backend: User + password_hash
Backend -> Backend: Verify password

alt Password Valid
    Backend -> Backend: Generate JWT tokens:\n- Access: 15 min\n- Refresh: 90 days (rememberMe)

    Backend -> Database: INSERT INTO refresh_tokens\n(token_hash, staff_id,\ndevice_name, ip_address,\nexpires_at: NOW() + 90 days)

    Backend -> Backend: Set HttpOnly cookie:\n- refreshToken\n- maxAge: 90 days\n- secure, sameSite: strict

    Backend --> Frontend: 200 OK {user, accessToken}
    Frontend -> Frontend: Store accessToken (memory)\nStore user (localStorage)
    Frontend -> Browser: Navigate to /home

else Password Invalid
    Backend --> Frontend: 401 Unauthorized\n"Invalid username or password"
    Frontend -> Browser: Show error message
end

== Back Button ==
User -> Browser: Click "Back"
Browser -> Frontend: handleBackToStep1()
Frontend -> Browser: Show Step 1\n(Username field)

@enduml
